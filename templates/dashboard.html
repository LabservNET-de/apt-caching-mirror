<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APT Cache Proxy</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0d1117; color: #e6edf3; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; }
        .navbar { background-color: #161b22 !important; border-bottom: 1px solid #30363d; }
        .card { background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; margin-bottom: 20px; }
        .card-header { background-color: #21262d; border-bottom: 1px solid #30363d; font-weight: 600; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-label { color: #8b949e; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .icon-box { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 1.5rem; }
        .bg-gradient-primary { background: linear-gradient(45deg, #238636, #2ea043); }
        .bg-gradient-info { background: linear-gradient(45deg, #1f6feb, #388bfd); }
        .bg-gradient-warning { background: linear-gradient(45deg, #9e6a03, #d29922); }
        .bg-gradient-danger { background: linear-gradient(45deg, #da3633, #f85149); }
        pre { background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; color: #e6edf3; }
        .nav-tabs .nav-link { color: #8b949e; }
        .nav-tabs .nav-link.active { background-color: #161b22; border-color: #30363d #30363d #161b22; color: #e6edf3; }
        .nav-tabs { border-bottom: 1px solid #30363d; }
        code { color: #a5d6ff; }
        .mirror-list { max-height: 300px; overflow-y: auto; }
        .mirror-item { border-bottom: 1px solid #30363d; padding: 8px 0; }
        .mirror-item:last-child { border-bottom: none; }
        .log-console { height: 300px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; background-color: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #21262d; padding-bottom: 2px; }
        .log-time { color: #8b949e; margin-right: 8px; }
        .log-level-INFO { color: #58a6ff; }
        .log-level-SUCCESS { color: #3fb950; }
        .log-level-WARNING { color: #d29922; }
        .log-level-ERROR { color: #f85149; }
        .modal-content { background-color: #161b22; border: 1px solid #30363d; color: #e6edf3; }
        .modal-header { border-bottom: 1px solid #30363d; }
        .modal-footer { border-top: 1px solid #30363d; }
        .form-control { background-color: #0d1117; border: 1px solid #30363d; color: #e6edf3; }
        .form-control:focus { background-color: #0d1117; border-color: #58a6ff; color: #e6edf3; box-shadow: 0 0 0 0.25rem rgba(88, 166, 255, 0.25); }
        .table { color: #e6edf3; }
        .table-hover tbody tr:hover { color: #e6edf3; background-color: #21262d; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <i class="bi bi-hdd-network"></i> APT Cache Proxy
            </a>
            <div class="d-flex align-items-center gap-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#cacheBrowserModal">
                    <i class="bi bi-search"></i> Browse Cache
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#configModal">
                    <i class="bi bi-gear-fill"></i> Setup Clients
                </button>
                <a href="/api/stats" class="text-decoration-none text-muted small"><i class="bi bi-code-slash"></i> JSON API</a>
                <span class="badge bg-success rounded-pill"><i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Online</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Total Requests</div>
                            <div class="stat-value" id="total-requests">0</div>
                        </div>
                        <div class="icon-box bg-gradient-info text-white">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Cache Hits</div>
                            <div class="stat-value text-success" id="cache-hits">0</div>
                        </div>
                        <div class="icon-box bg-gradient-primary text-white">
                            <i class="bi bi-check-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Cache Misses</div>
                            <div class="stat-value text-warning" id="cache-misses">0</div>
                        </div>
                        <div class="icon-box bg-gradient-warning text-white">
                            <i class="bi bi-cloud-download"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Data Served</div>
                            <div class="stat-value" id="bytes-served">0 B</div>
                        </div>
                        <div class="icon-box bg-gradient-danger text-white">
                            <i class="bi bi-hdd"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Column: Charts & System -->
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-pie-chart-fill me-2"></i>Cache Distribution</span>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="distroChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-terminal me-2"></i>Live Activity Log
                    </div>
                    <div class="card-body p-0">
                        <div class="log-console" id="log-console">
                            <!-- Logs will appear here -->
                            <div class="text-muted text-center mt-5">Waiting for activity...</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-info-circle-fill me-2"></i>System Status
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <h6 class="text-muted">Uptime</h6>
                                <h4 id="uptime">-</h4>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted">Cached Files</h6>
                                <h4 id="cached-files">0</h4>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted">Storage Usage</h6>
                                <h4 id="total-size">0 MB</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-ul me-2"></i>Configured Mirrors
                    </div>
                    <div class="card-body mirror-list" id="mirror-list">
                        <!-- Mirrors will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel"><i class="bi bi-terminal-fill me-2"></i>Client Configuration</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Configure your clients to use this server as a proxy.</p>

                    <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="proxy-tab" data-bs-toggle="tab" data-bs-target="#proxy" type="button" role="tab">Proxy (Recommended)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="direct-tab" data-bs-toggle="tab" data-bs-target="#direct" type="button" role="tab">Direct</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="configTabsContent">
                        <!-- Method 1: Proxy -->
                        <div class="tab-pane fade show active" id="proxy" role="tabpanel">
                            <h6 class="text-success small"><i class="bi bi-ubuntu"></i> Debian / Ubuntu</h6>
                            <pre class="p-2 mb-2 small"><code>Acquire::http::Proxy "http://<span class="host-ip">IP</span><span class="host-port-suffix"></span>";</code></pre>
                            <div class="text-muted small mb-3 fst-italic">File: /etc/apt/apt.conf.d/00aptproxy</div>

                            <h6 class="text-success small"><i class="bi bi-box-seam"></i> CentOS / Fedora</h6>
                            <pre class="p-2 mb-2 small"><code>proxy=http://<span class="host-ip">IP</span><span class="host-port-suffix"></span></code></pre>
                            <div class="text-muted small fst-italic">File: /etc/yum.conf</div>
                        </div>

                        <!-- Method 2: Direct -->
                        <div class="tab-pane fade" id="direct" role="tabpanel">
                            <h6 class="text-info small">Debian / Ubuntu</h6>
                            <pre class="p-2 mb-2 small"><code>deb http://<span class="host-ip">IP</span><span class="host-port-suffix"></span>/debian bookworm main</code></pre>
                            <div class="text-muted small fst-italic">File: /etc/apt/sources.list</div>

                            <h6 class="text-info small mt-3"><i class="bi bi-box-seam"></i> Arch Linux</h6>
                            <pre class="p-2 mb-2 small"><code>Server = http://<span class="host-ip">IP</span><span class="host-port-suffix"></span>/archlinux/$repo/os/$arch</code></pre>
                            <div class="text-muted small fst-italic">File: /etc/pacman.d/mirrorlist (Add to top)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Browser Modal -->
    <div class="modal fade" id="cacheBrowserModal" tabindex="-1" aria-labelledby="cacheBrowserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cacheBrowserModalLabel"><i class="bi bi-search me-2"></i>Browse Cached Packages</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-dark border-secondary text-light"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="cacheSearchInput" placeholder="Search for packages (e.g. 'vim', 'kernel')...">
                        <button class="btn btn-primary" type="button" onclick="searchCache()">Search</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Package Name</th>
                                    <th>Distro</th>
                                    <th>Size</th>
                                    <th>Cached Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="cacheSearchResults">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">Enter a search term to find cached packages.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-detect host info
        document.querySelectorAll('.host-ip').forEach(el => el.innerText = window.location.hostname);

        const port = window.location.port || '80';
        const portSuffix = (port === '80' || port === '443') ? '' : ':' + port;
        document.querySelectorAll('.host-port-suffix').forEach(el => el.innerText = portSuffix);

        let distroChart = null;
        let lastLogTime = null;

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function updateChart(distros) {
            const ctx = document.getElementById('distroChart').getContext('2d');
            const labels = Object.keys(distros);
            const data = Object.values(distros).map(d => d.size); // Use size for chart

            // Dark theme colors
            const colors = [
                '#238636', '#1f6feb', '#d29922', '#da3633', '#8957e5', '#3fb950', '#a5d6ff'
            ];

            if (distroChart) {
                distroChart.data.labels = labels;
                distroChart.data.datasets[0].data = data;
                distroChart.update();
            } else {
                distroChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#161b22',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#e6edf3' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatBytes(context.raw);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateMirrors(mirrors) {
            const container = document.getElementById('mirror-list');
            container.innerHTML = '';

            for (const [name, urls] of Object.entries(mirrors)) {
                const div = document.createElement('div');
                div.className = 'mirror-item';

                const urlList = Array.isArray(urls) ? urls : [urls];
                const urlHtml = urlList.map(u => `<div class="text-muted small text-truncate">${u}</div>`).join('');

                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-info">${name}</span>
                        <span class="badge bg-secondary">${urlList.length}</span>
                    </div>
                    ${urlHtml}
                `;
                container.appendChild(div);
            }
        }

        function updateLogs(logs) {
            if (!logs || logs.length === 0) return;

            const container = document.getElementById('log-console');
            // Clear initial message if present
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }

            // Only append new logs (simple check based on content/time, or just rebuild for simplicity)
            // For simplicity in this polling model, we'll just rebuild the list but keep scroll position if at bottom

            const isAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <span class="log-time">[${log.time}]</span>
                    <span class="log-level-${log.level} fw-bold">${log.level}</span>:
                    <span class="text-break">${log.message}</span>
                </div>
            `).join('');

            if (isAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function searchCache() {
            const query = document.getElementById('cacheSearchInput').value;
            const resultsBody = document.getElementById('cacheSearchResults');

            if (!query) return;

            resultsBody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';

            fetch(`/api/cache/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No packages found matching your query.</td></tr>';
                        return;
                    }

                    resultsBody.innerHTML = data.map(item => `
                        <tr>
                            <td><span class="text-info">${item.name}</span></td>
                            <td><span class="badge bg-secondary">${item.distro}</span></td>
                            <td>${formatBytes(item.size)}</td>
                            <td class="text-muted small">${item.mtime}</td>
                            <td>
                                <a href="/api/cache/download?path=${encodeURIComponent(item.path)}" class="btn btn-sm btn-outline-success" target="_blank">
                                    <i class="bi bi-download"></i>
                                </a>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    resultsBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Error searching cache: ${err}</td></tr>`;
                });
        }

        // Allow Enter key to search
        document.getElementById('cacheSearchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchCache();
            }
        });

        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-requests').innerText = data.requests_total;
                    document.getElementById('cache-hits').innerText = data.cache_hits;
                    document.getElementById('cache-misses').innerText = data.cache_misses;
                    document.getElementById('bytes-served').innerText = formatBytes(data.bytes_served);
                    document.getElementById('uptime').innerText = data.uptime;
                    document.getElementById('cached-files').innerText = data.total_cached_files;
                    document.getElementById('total-size').innerText = data.total_cache_size_mb + ' MB';

                    if (data.distro_stats) {
                        updateChart(data.distro_stats);
                    }

                    if (data.mirrors) {
                        updateMirrors(data.mirrors);
                    }

                    if (data.logs) {
                        updateLogs(data.logs);
                    }
                });
        }

        setInterval(updateStats, 2000); // Faster update for logs
        updateStats();
    </script>
</body>
</html>